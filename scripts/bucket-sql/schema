CREATE TABLE object(key, last_modified, etag, size, bucket);
create table metadata (info_hash_hex primary key, metadata);

CREATE VIEW data_suf as
	with
		first_slash as (
			select instr(key, '/') as first_slash_index, *
			from object ),
		second_slash as (
			select instr(substr(key, first_slash_index+1), '/') as second_slash_index, *
			from first_slash where first_slash_index<>0 )
	select
		substr(key, first_slash_index+second_slash_index+1) as data_suf,
		*
	from second_slash
	where substr(key, first_slash_index+1, second_slash_index-1)='data'
/* data_suf(data_suf,second_slash_index,first_slash_index,"key",last_modified,etag,size,bucket) */;
CREATE VIEW info_name as
	with
		first_slash as (
			select instr(data_suf, '/') as first_slash, *
			from data_suf )
	select
		iif(first_slash=0, data_suf, substr(data_suf, 1, first_slash-1)) as info_name,
		*
	from first_slash
/* info_name(info_name,first_slash,data_suf,second_slash_index,first_slash_index,"key",last_modified,etag,size,bucket) */;
CREATE VIEW user_upload as
	select * from info_name where instr(info_name, '_')=0 and instr(info_name, ' ')=0
/* user_upload(info_name,first_slash,data_suf,second_slash_index,first_slash_index,"key",last_modified,etag,size,bucket) */;
CREATE VIEW info_hash as
	select substr(key, 1, 40) as info_hash, *
	from object
	where instr(key, '/')=41 or length(key)=40
/* info_hash(info_hash,"key",last_modified,etag,size,bucket) */;
