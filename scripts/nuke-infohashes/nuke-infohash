set -ue

# Takes a file of <bucket> <aws profile>, then a file of infohashes, then any other parameters are passed directly to aws s3 rm (you might want to pass --dryrun to check what will happen).

s3=$1
shift
infohashes=$1
shift

while read infohash; do
	# Skip empty lines
	[ -n "$infohash" ] || continue
	# Don't allow something that isn't an infohash, to avoid deleting an entire bucket (the trailing slash should prevent that though).
	(( ${#infohash} == 40 )) || { printf >&2 "bad infohash '%q'\n" "$infohash"; exit 1; }
	while read bucket profile; do
		#echo $profile $bucket $infohash
		aws s3 rm "$@" --recursive --profile "$profile" "s3://$bucket/$infohash/"
	done < "$s3"
done < "$infohashes"
