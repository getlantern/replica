#!/bin/bash

# This can be used to delete queues that meet certain criteria, around pending
# messages (implying that nothing has consumed them for a while), and queue
# modification age. It's useful as a reference for structuring aws cli
# commands too. I probably should have just written in Python to begin with,
# but that's not as easy to work with interactively to discover how to do this
# stuff.

set -eux
: "${AWS_PARALLELISM:=10}"
: "${XARGS_PARAMS:=-L 1 -P $AWS_PARALLELISM}"
MAX_AGE_TIMESTAMP="$(date --date "$MAX_AGE" +%s)"

aws sqs list-queues --queue-name-prefix "$QUEUE_NAME_PREFIX" \
| jq '.QueueUrls | .[]' \
| xargs ${XARGS_PARAMS[@]} aws sqs get-queue-attributes --attribute-names All --queue-url \
| jq ".Attributes | select(.ApproximateNumberOfMessages | tonumber >= ${MIN_PENDING_MESSAGES:-2000}) | select(.LastModifiedTimestamp | tonumber < $MAX_AGE_TIMESTAMP)" \
| jq '.QueueArn | split(":")[-1]' \
| xargs ${XARGS_PARAMS[@]} aws sqs get-queue-url --queue-name \
| jq '.QueueUrl' \
| tee /dev/tty \
| xargs ${XARGS_PARAMS[@]} aws sqs delete-queue --queue-url
